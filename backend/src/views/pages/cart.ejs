<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - ATRIX Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('../partials/navbar', { user }) %>

<div class="container my-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active">Shopping Cart</li>
        </ol>
    </nav>

    <h1 class="mb-4" style="font-family: 'Playfair Display', serif;">Shopping Cart</h1>

    <div class="row g-5">
        <!-- Cart Items -->
        <div class="col-lg-8">
            <div id="cartItems">
                <!-- Loading State -->
                <div class="text-center py-5" id="cartLoading">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-3">Loading your cart...</p>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="order-summary-card bg-light rounded-4 p-4 sticky-top" style="top: 100px;">
                <h5 class="mb-4 fw-bold" style="font-family: 'Playfair Display', serif;">Order Summary</h5>
                
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Subtotal</span>
                    <span class="fw-semibold" id="subtotal">$0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Shipping</span>
                    <span class="fw-semibold" id="shipping">$10.00</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Tax (8%)</span>
                    <span class="fw-semibold" id="tax">$0.00</span>
                </div>
                
                <hr class="my-4">
                
                <div class="d-flex justify-content-between mb-4">
                    <span class="h5 mb-0">Total</span>
                    <span class="h5 mb-0 fw-bold" style="color: var(--accent);" id="total">$0.00</span>
                </div>

                <a href="/checkout" class="btn-premium btn-primary-premium w-100 d-block text-center mb-3" id="checkoutBtn">
                    Proceed to Checkout <i class="bi bi-arrow-right ms-2"></i>
                </a>
                
                <a href="/shop" class="btn-premium btn-outline-premium w-100 d-block text-center">
                    <i class="bi bi-arrow-left me-2"></i>Continue Shopping
                </a>

                <!-- Trust Badges -->
                <div class="mt-4 pt-4 border-top">
                    <div class="d-flex align-items-center gap-2 mb-2 text-muted">
                        <i class="bi bi-shield-check"></i>
                        <small>Secure Checkout</small>
                    </div>
                    <div class="d-flex align-items-center gap-2 mb-2 text-muted">
                        <i class="bi bi-truck"></i>
                        <small>Free Shipping Over $100</small>
                    </div>
                    <div class="d-flex align-items-center gap-2 text-muted">
                        <i class="bi bi-arrow-clockwise"></i>
                        <small>30-Day Returns</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    await loadCart();
});

async function loadCart() {
    try {
        const response = await fetch('/api/cart', {
            credentials: 'include'
        });
        const data = await response.json();

        if (data.success) {
            renderCart(data.cart);
        } else {
            renderEmptyCart();
        }
    } catch (error) {
        console.error('Error loading cart:', error);
        renderEmptyCart();
    }
}

function renderEmptyCart() {
    document.getElementById('cartItems').innerHTML = `
        <div class="text-center py-5">
            <i class="bi bi-cart-x display-1 text-muted mb-4"></i>
            <h4 class="mb-3" style="font-family: 'Playfair Display', serif;">Your cart is empty</h4>
            <p class="text-muted mb-4">Looks like you haven't added any items to your cart yet.</p>
            <a href="/shop" class="btn-premium btn-primary-premium">
                <i class="bi bi-bag me-2"></i>Start Shopping
            </a>
        </div>
    `;
    document.getElementById('checkoutBtn').classList.add('disabled');
}

function renderCart(cart) {
    const cartItemsDiv = document.getElementById('cartItems');
    
    if (!cart.items || cart.items.length === 0) {
        renderEmptyCart();
        return;
    }

    cartItemsDiv.innerHTML = cart.items.map(item => `
        <div class="cart-item-card bg-white rounded-4 p-4 mb-3 shadow-sm" data-cart-item="${item.id}">
            <div class="row align-items-center g-3">
                <div class="col-3 col-md-2">
                    <img src="${item.product.imageUrl || 'https://images.unsplash.com/photo-1560343090-f0409e92791a?w=200'}" 
                         class="img-fluid rounded-3" 
                         alt="${item.product.name}"
                         style="aspect-ratio: 1; object-fit: cover;">
                </div>
                <div class="col-9 col-md-5">
                    <a href="/product/${item.product.slug}" class="text-decoration-none text-dark">
                        <h6 class="fw-semibold mb-1">${item.product.name}</h6>
                    </a>
                    <p class="text-muted small mb-2">${item.product.shortDescription || ''}</p>
                    <p class="fw-bold mb-0" style="color: var(--accent);">$${parseFloat(item.product.price).toFixed(2)}</p>
                </div>
                <div class="col-6 col-md-3">
                    <div class="quantity-selector d-flex align-items-center justify-content-center">
                        <button type="button" class="qty-btn" onclick="updateQuantity(${item.id}, ${item.quantity - 1})">âˆ’</button>
                        <input type="text" class="qty-input" value="${item.quantity}" readonly>
                        <button type="button" class="qty-btn" onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                    </div>
                </div>
                <div class="col-4 col-md-1 text-end">
                    <h6 class="mb-0 fw-bold">$${(parseFloat(item.product.price) * item.quantity).toFixed(2)}</h6>
                </div>
                <div class="col-2 col-md-1 text-end">
                    <button onclick="removeFromCart(${item.id})" class="btn btn-link text-danger p-0" title="Remove item">
                        <i class="bi bi-trash fs-5"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');

    updateOrderSummary(cart);
    document.getElementById('checkoutBtn').classList.remove('disabled');
}

function updateOrderSummary(cart) {
    const subtotal = cart.items.reduce((sum, item) => sum + (parseFloat(item.product.price) * item.quantity), 0);
    const shipping = subtotal > 100 ? 0 : (subtotal > 0 ? 10 : 0);
    const tax = subtotal * 0.08;
    const total = subtotal + shipping + tax;

    document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
    document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : '$' + shipping.toFixed(2);
    document.getElementById('tax').textContent = '$' + tax.toFixed(2);
    document.getElementById('total').textContent = '$' + total.toFixed(2);
}

async function updateQuantity(cartItemId, newQuantity) {
    if (newQuantity < 1) {
        removeFromCart(cartItemId);
        return;
    }

    try {
        const response = await fetch(`/api/cart/${cartItemId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ quantity: newQuantity })
        });

        const data = await response.json();
        if (data.success) {
            await loadCart();
        } else {
            showToast(data.message || 'Error updating cart', 'error');
        }
    } catch (error) {
        showToast('Error updating cart', 'error');
    }
}

async function removeFromCart(cartItemId) {
    try {
        const response = await fetch(`/api/cart/${cartItemId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        const data = await response.json();
        if (data.success) {
            await loadCart();
            showToast('Item removed from cart', 'success');
        }
    } catch (error) {
        showToast('Error removing item', 'error');
    }
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.innerHTML = `
        <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill'} me-2"></i>
        ${message}
    `;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        z-index: 9999;
        animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
</style>

<%- include('../partials/footer') %>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
