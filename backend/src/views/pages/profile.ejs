<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - ATRIX Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('../partials/navbar', { user }) %>

<div class="container my-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active">My Profile</li>
        </ol>
    </nav>

    <h1 class="mb-4" style="font-family: 'Playfair Display', serif;">My Profile</h1>

    <div class="row g-4">
        <!-- Profile Forms -->
        <div class="col-lg-8">
            <!-- Personal Information Card -->
            <div class="bg-white rounded-4 shadow-sm p-4 mb-4">
                <div class="d-flex align-items-center gap-3 mb-4">
                    <div class="section-icon">
                        <i class="bi bi-person fs-4"></i>
                    </div>
                    <h5 class="mb-0 fw-bold">Personal Information</h5>
                </div>
                <form id="profileForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">First Name</label>
                            <input type="text" class="form-control form-control-lg" name="firstName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Last Name</label>
                            <input type="text" class="form-control form-control-lg" name="lastName" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">Email</label>
                            <input type="email" class="form-control form-control-lg bg-light" name="email" readonly>
                            <small class="text-muted"><i class="bi bi-lock me-1"></i>Email cannot be changed</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">Phone</label>
                            <input type="tel" class="form-control form-control-lg" name="phone" placeholder="+1 (555) 123-4567">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn-premium btn-primary-premium">
                                <i class="bi bi-check-lg me-2"></i>Update Profile
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Shipping Address Card -->
            <div class="bg-white rounded-4 shadow-sm p-4 mb-4">
                <div class="d-flex align-items-center gap-3 mb-4">
                    <div class="section-icon">
                        <i class="bi bi-geo-alt fs-4"></i>
                    </div>
                    <h5 class="mb-0 fw-bold">Shipping Address</h5>
                </div>
                <form id="addressForm">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-semibold">Street Address</label>
                            <input type="text" class="form-control form-control-lg" name="shippingAddress" placeholder="123 Main Street, Apt 4B">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label fw-semibold">City</label>
                            <input type="text" class="form-control form-control-lg" name="city" placeholder="New York">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">State</label>
                            <input type="text" class="form-control form-control-lg" name="state" placeholder="NY">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">ZIP Code</label>
                            <input type="text" class="form-control form-control-lg" name="postalCode" placeholder="10001">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">Country</label>
                            <select class="form-select form-select-lg" name="country">
                                <option value="USA" selected>United States</option>
                                <option value="CAN">Canada</option>
                                <option value="GBR">United Kingdom</option>
                                <option value="AUS">Australia</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn-premium btn-primary-premium">
                                <i class="bi bi-check-lg me-2"></i>Save Address
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Change Password Card -->
            <div class="bg-white rounded-4 shadow-sm p-4">
                <div class="d-flex align-items-center gap-3 mb-4">
                    <div class="section-icon">
                        <i class="bi bi-shield-lock fs-4"></i>
                    </div>
                    <h5 class="mb-0 fw-bold">Change Password</h5>
                </div>
                <form id="passwordForm">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-semibold">Current Password</label>
                            <input type="password" class="form-control form-control-lg" name="currentPassword" placeholder="••••••••">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">New Password</label>
                            <input type="password" class="form-control form-control-lg" name="newPassword" placeholder="••••••••">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Confirm New Password</label>
                            <input type="password" class="form-control form-control-lg" name="confirmPassword" placeholder="••••••••">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn-premium btn-outline-premium">
                                <i class="bi bi-key me-2"></i>Update Password
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Profile Sidebar -->
        <div class="col-lg-4">
            <!-- User Info Card -->
            <div class="bg-white rounded-4 shadow-sm p-4 text-center mb-4">
                <div class="profile-avatar mb-3">
                    <div class="avatar-circle mx-auto" style="width: 100px; height: 100px; background: linear-gradient(135deg, var(--accent, #e94560) 0%, #d63954 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <span class="text-white display-4 fw-bold" id="userInitials">U</span>
                    </div>
                </div>
                <h4 class="mb-1" id="userName" style="font-family: 'Playfair Display', serif;">User</h4>
                <p class="text-muted mb-3" id="userEmail">user@example.com</p>
                <span class="badge bg-light text-dark px-3 py-2">
                    <i class="bi bi-calendar3 me-1"></i>Member since <span id="memberSince">--</span>
                </span>
            </div>

            <!-- Account Statistics Card -->
            <div class="bg-white rounded-4 shadow-sm p-4 mb-4">
                <h6 class="fw-bold mb-4">Account Statistics</h6>
                <div class="row g-3">
                    <div class="col-6">
                        <div class="stat-card bg-light rounded-3 p-3 text-center">
                            <i class="bi bi-bag fs-3 text-muted mb-2"></i>
                            <h4 class="mb-0 fw-bold" id="totalOrders">0</h4>
                            <small class="text-muted">Orders</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card bg-light rounded-3 p-3 text-center">
                            <i class="bi bi-wallet2 fs-3 text-muted mb-2"></i>
                            <h4 class="mb-0 fw-bold" style="color: var(--accent);" id="totalSpent">$0</h4>
                            <small class="text-muted">Total Spent</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Links Card -->
            <div class="bg-white rounded-4 shadow-sm p-4">
                <h6 class="fw-bold mb-3">Quick Links</h6>
                <div class="d-grid gap-2">
                    <a href="/orders" class="btn btn-light text-start">
                        <i class="bi bi-bag-check me-2"></i>View My Orders
                    </a>
                    <a href="/cart" class="btn btn-light text-start">
                        <i class="bi bi-cart me-2"></i>Shopping Cart
                    </a>
                    <a href="/shop" class="btn btn-light text-start">
                        <i class="bi bi-shop me-2"></i>Continue Shopping
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.section-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--accent, #e94560) 0%, #d63954 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}
.form-control:focus, .form-select:focus {
    border-color: var(--accent, #e94560);
    box-shadow: 0 0 0 0.2rem rgba(233, 69, 96, 0.15);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    await loadUserProfile();
});

async function loadUserProfile() {
    try {
        const response = await fetch('/api/auth/me', {
            credentials: 'include'
        });
        const data = await response.json();

        if (data.success) {
            populateProfile(data.user);
        }
    } catch (error) {
        console.error('Error loading profile:', error);
    }
}

function populateProfile(user) {
    const fullName = `${user.firstName} ${user.lastName}`;
    document.getElementById('userName').textContent = fullName;
    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('userInitials').textContent = (user.firstName?.charAt(0) || '') + (user.lastName?.charAt(0) || '');
    document.getElementById('memberSince').textContent = new Date(user.createdAt).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

    const profileForm = document.getElementById('profileForm');
    profileForm.firstName.value = user.firstName || '';
    profileForm.lastName.value = user.lastName || '';
    profileForm.email.value = user.email || '';
    profileForm.phone.value = user.phone || '';

    const addressForm = document.getElementById('addressForm');
    addressForm.shippingAddress.value = user.shippingAddress || '';
    addressForm.city.value = user.city || '';
    addressForm.state.value = user.state || '';
    addressForm.postalCode.value = user.postalCode || '';
    addressForm.country.value = user.country || 'USA';

    loadUserStats();
}

async function loadUserStats() {
    try {
        const response = await fetch('/api/orders', {
            credentials: 'include'
        });
        const data = await response.json();

        if (data.success) {
            document.getElementById('totalOrders').textContent = data.orders.length;
            const totalSpent = data.orders.reduce((sum, order) => sum + parseFloat(order.total), 0);
            document.getElementById('totalSpent').textContent = '$' + totalSpent.toFixed(0);
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.innerHTML = `
        <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill'} me-2"></i>
        ${message}
    `;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        z-index: 9999;
        animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    btn.disabled = true;

    const formData = new FormData(e.target);
    const data = {
        firstName: formData.get('firstName'),
        lastName: formData.get('lastName'),
        phone: formData.get('phone')
    };

    try {
        const response = await fetch('/api/auth/profile', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            showToast('Profile updated successfully', 'success');
            document.getElementById('userName').textContent = `${data.firstName} ${data.lastName}`;
            document.getElementById('userInitials').textContent = (data.firstName?.charAt(0) || '') + (data.lastName?.charAt(0) || '');
        } else {
            showToast(result.message || 'Error updating profile', 'error');
        }
    } catch (error) {
        showToast('Error updating profile', 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});

document.getElementById('addressForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    btn.disabled = true;

    const formData = new FormData(e.target);
    const data = {
        shippingAddress: formData.get('shippingAddress'),
        city: formData.get('city'),
        state: formData.get('state'),
        postalCode: formData.get('postalCode'),
        country: formData.get('country')
    };

    try {
        const response = await fetch('/api/auth/profile', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            showToast('Address updated successfully', 'success');
        } else {
            showToast(result.message || 'Error updating address', 'error');
        }
    } catch (error) {
        showToast('Error updating address', 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});

document.getElementById('passwordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    if (formData.get('newPassword') !== formData.get('confirmPassword')) {
        showToast('Passwords do not match', 'error');
        return;
    }
    
    showToast('Password change feature coming soon', 'info');
});
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
</style>

<%- include('../partials/footer') %>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
